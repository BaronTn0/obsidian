このチートシートでは、Microsoft Office、RTF、PDFファイルなどの悪意のあるドキュメントを分析するためのヒントとツールの概要を説明しています。印刷するには、1ページの[PDF](https://zeltser.com/media/docs/analyzing-malicious-document-files.pdf)バージョンを使用してください。[Wordの](https://zeltser.com/media/docs/analyzing-malicious-document-files.docx)バージョンを編集して、自分のニーズに合わせてカスタマイズすることもできます。

## ドキュメント分析への一般的なアプローチ

1.  危険なタグ、スクリプト、埋め込まれたアーティファクトなどの異常がないかドキュメントを調べます。
2.  シェルコード、マクロ、JavaScript、その他の疑わしいオブジェクトなどの埋め込みコードを見つけます。
3.  疑わしいコードまたはオブジェクトをファイルから抽出します。
4.  必要に応じて、マクロ、JavaScript、またはその他の埋め込みコードの難読化を解除して調べます。
5.  必要に応じて、ドキュメントから抽出したシェルコードをエミュレート、逆アセンブル、および/またはデバッグします。
6.  感染チェーンの次のステップを理解します。

## MicrosoftOffice形式のメモ

-   バイナリMicrosoftOfficeドキュメントファイル（.doc、.xlsなど）は、OLE2（別名Structured Storage）形式を使用します。
-   OLE2ドキュメントのSRPストリームには、[以前のVBAマクロコードの](https://www.sans.org/blog/srp-streams-in-ms-office-documents-reveal-earlier-versions-of-malicious-macros/)キャッシュバージョンが保存される場合があり[ます](https://www.sans.org/blog/srp-streams-in-ms-office-documents-reveal-earlier-versions-of-malicious-macros/)。
-   Microsoft OfficeでサポートされているOOXMLドキュメントファイル（.docx、.xlsmなど）は、圧縮されたzipアーカイブです。
-   OOXMLドキュメントのVBAマクロは、zipアーカイブ内のOLE2バイナリファイル内に保存されます。
-   Excelは、OLE2バイナリファイルなしで数式としてシートに埋め込まれるXLMマクロをサポートします。
-   RTFドキュメントはマクロをサポートしていませんが、悪意のある埋め込みファイルやオブジェクトが含まれている可能性があります。

## 便利なMicrosoftOfficeファイル分析コマンド

[zipdump.py](https://videos.didierstevens.com/2014/08/14/zipdump-py/)  _file.pptx_

OOXMLファイル_file.pptxの_内容を _調べ_ます。

[zipdump.py](https://videos.didierstevens.com/2014/08/14/zipdump-py/)  _file.pptx -s 3 -d_

インデックスの抽出ファイル _3_から _file.pptx_ STDOUTへ。

[olevba](https://github.com/decalage2/oletools/wiki/olevba)  _file.xlsm_

_file.xlsm_からマクロを見つけて抽出します 。

[oledump.py](https://blog.didierstevens.com/programs/oledump-py/)  _file.xls_ -i

_file.xlsに_存在するすべてのOLE2ストリームを一覧表示し _ます_。

oledump.py _file.xls _ -s _3_ -v

_file.xlsの_ストリーム_3_からVBAソースコードを抽出  し _ます_。

[xmldump.py](https://blog.didierstevens.com/2018/01/15/update-xmldump-py-version-0-0-2/) かなり

分析を容易にするために、STDINを介して提供されるXMLファイルをフォーマットします。

oledump.py _file.xls_ -p plugin\_http\_heuristics

_file.xls_ マクロで難読化されたURLを _見つけ_ます。

[vmonkey](https://github.com/decalage2/ViperMonkey)  _file.doc_

file.doc内のマクロの実行をエミュレートして、それらを分析します。

[evilclippy](https://github.com/outflanknl/EvilClippy) -uu _file.ppt_

_file.pptの_マクロからパスワードプロンプトを削除します 。

[msoffcrypto-tool](https://github.com/nolze/msoffcrypto-tool) _infile.docm_  _outfile.docm -p_

 指定されたパスワードを使用_して__file.docm_を復号化 _し、__file.docm_を作成 _し__ます_。

[pcodedmp](https://github.com/bontchev/pcodedmp)  _file.doc_

_file.doc_  
からVBAを_踏み込んだ_pコードマクロを逆アセンブル し _ます_。

[pcode2code](https://github.com/Big5-sec/pcode2code) file.doc

_file.doc_  
からVBAで_踏み込んだ_pコードマクロを逆コンパイル し _ます_。

[rtfobj.py](https://www.decalage.info/python/rtfobj)  _file.rtf_

_RTFfile.rtfに_埋め込まれたオブジェクトを抽出します 。

[rtfdump.py](https://blog.didierstevens.com/2016/08/02/rtfdump-update-and-videos/)  _file.rtf_

RTFファイル_file.rtfの_グループと構造を一覧表示します 。

rtfdump.py _file.rtf _ -O

RTFファイル_file.rtf_内のオブジェクトを _調べ_ます。

rtfdump.py _file.rtf_ -s _5_ -H -d

RTFファイル_file.rtfの_グループから16進コンテンツを抽出します 。

[xlmdeobfuscator](https://github.com/DissectMalware/XLMMacroDeobfuscator) --file _file.xlsm_

file.xlsm内のXLM（Excel 4）マクロの _難読化を解除し_ます。

## 危険なPDFキーワード

-   / OpenActionおよび/ AAは、自動的に実行するスクリプトまたはアクションを指定します。
-   / JavaScript、/ JS、/ AcroForm、および/ XFAは、実行するJavaScriptを指定できます。
-   / URIは、おそらくフィッシングのために、そのURLによってリソースにアクセスします。
-   / SubmitFormと/ GoToRはデータをURLに送信できます。
-   / RichMediaを使用して、FlashをPDFに埋め込むことができます。
-   / ObjStmは、オブジェクトストリーム内のオブジェクトを非表示にすることができます。
-   / XObjectは、フィッシング用の画像を埋め込むことができます。
-   / JavaScriptと/ J＃61vaScriptなどの16進コードの難読化に注意してください。（[例を参照してください](https://blog.didierstevens.com/2008/04/29/pdf-let-me-count-the-ways/)。）

## 便利なPDFファイル分析コマンド

[pdfid.py](https://blog.didierstevens.com/programs/pdf-tools/)  _file.pdf_ -n

ファイル_file.pdfに_存在する危険なキーワードを表示します 。

[pdf-parser.py](https://blog.didierstevens.com/programs/pdf-tools/) _file.pdf_ -a

キーワードに関する統計を表示します。「-O」を追加して、オブジェクトストリームを含めます。

pdf-parser.py _file.pdf _ -o _id_

オブジェクト_IDの_内容を表示します 。オブジェクトのストリームをダンプするには、「-d」を追加します。

pdf-parser.py _file.pdf _ -r _id_

オブジェクト_ID_を参照するオブジェクトを表示します 。

_[qpdf](http://qpdf.sourceforge.net/) --password = pass --decrypt infile.pdf outfile.pdf_

 パスワード_パス_ を使用して_infile.pdf_を復号 _化_し、 _outfile.pdf_を作成します 。

## シェルコードおよびその他の分析コマンド

[xorsearch](https://blog.didierstevens.com/2014/09/29/update-xorsearch-with-shellcode-detector/) -W -d 3 _file.bin_

バイナリファイル_file.bin_内のシェルコードパターンを見つけます 。

[scdbgc](http://sandsprite.com/blogs/index.php?uid=7&pid=152) / f _file.bin_

_file.bin_でシェルコードの実行をエミュ _レートし_ます。「/ off」を使用してオフセットを指定します。

[runc32](https://github.com/edygert/runsc) -f _file.bin_ -n

_file.binで_シェルコードを実行  して、隔離されたラボでの動作を観察します。

[base64dump.py](https://blog.didierstevens.com/2017/07/02/update-base64dump-py-version-0-0-7/) _file.txt_

ファイル_file.txtに_存在するBase64でエンコードされた文字列を一覧表示します 。

[numbers-to-string.py](https://videos.didierstevens.com/2016/10/11/maldoc-numbers-to-string-py/) _ファイル_

_ファイル内の_文字を表す数値を 文字列に変換し _ます_。

##  追加のドキュメント分析ツール

-   [SpiderMonkey](https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey)、 [cscript](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cscript)、および [box-jsは](https://github.com/CapacitorSet/box-js) 、ドキュメントファイルから抽出したJavaScriptの難読化を解除するのに役立ちます。
-   Microsoft Officeに組み込まれているデバッガーを使用して、隔離されたラボでマクロの難読化を解除します。
-   [AMSIScriptContentRetrieval.ps1](https://gist.githubusercontent.com/mattifestation/e179218d88b5f100b0edecdec453d9be/raw/2329bda456b5b8e2f973cc5dc026b6fc221dad79/AMSIScriptContentRetrieval.ps1) を使用 して、MicrosoftOfficeが隔離されたラボでマクロを実行するのを観察します。
-   一部の [自動分析サンドボックス](https://zeltser.com/automated-malware-analysis/) は、悪意のあるドキュメントファイルの側面を分析できます。
-   [REMnux](https://remnux.org/) ディストリビューションには、上記の無料のドキュメント分析ツールの多くが含まれています。

## ポストスクリプトム

[PedroBueno](http://handlers.dshield.org/pbueno/) と[DidierStevens](http://blog.didierstevens.com/)へのフィードバックに特に感謝します。このチートシートを改善するための提案があれば[、私に知らせて](https://zeltser.com/contact/)ください。このチートシートバージョン4.1の[クリエイティブコモンズv3「帰属」ライセンス](http://creativecommons.org/licenses/by/3.0/)。

2021年7月22日更新

